<div class="liba-theme container equipos-page">
  <h1>
    <i class="fas fa-screwdriver-wrench"></i>
    | Gestión de Equipos
  </h1>

  <!-- Tarjetas de Dashboard -->
  <div class="dashboard-cards">
    <div class="action-card" (click)="toggleFormulario('hojaVida')" [class.active]="formularioActivo === 'hojaVida'">
      <i class="fas fa-file-medical"></i>
      <span>Registrar Hoja de Vida</span>
    </div>

    <div class="action-card" (click)="toggleFormulario('fichaTecnica')" [class.active]="formularioActivo === 'fichaTecnica'">
      <i class="fas fa-clipboard-list"></i>
      <span>Registrar Ficha Técnica</span>
    </div>

    <div class="action-card" (click)="toggleFormulario('historial')" [class.active]="formularioActivo === 'historial'">
      <i class="fas fa-history"></i>
      <span>Registrar Historial de Equipo</span>
    </div>

    <div class="action-card" (click)="toggleFormulario('intervalo')" [class.active]="formularioActivo === 'intervalo'">
      <i class="fas fa-calendar-alt"></i>
      <span>Registrar Intervalo de Equipo</span>
    </div>
  </div>

  <!-- Formulario de Hoja de Vida -->
  <div *ngIf="formularioActivo === 'hojaVida'" class="form-section">
    <h2>
      <i class="fas fa-file-medical"></i>
      | Registrar Equipo (Hoja de Vida)
    </h2>
    <section>
      <form class="form-grid" (submit)="crearEquipo($event)">
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">Datos generales</div>
        <div>
          <label for="codigo_identificacion">Código de identificación *</label>
          <input id="codigo_identificacion" name="codigo_identificacion" [(ngModel)]="codigo_identificacion" required placeholder="Ej: EQ-001" />
        </div>
        <div>
          <label for="nombre">Nombre *</label>
          <input id="nombre" name="nombre" [(ngModel)]="nombre" required placeholder="Ej: Balanza analítica" />
        </div>
        <div>
          <label for="modelo">Modelo</label>
          <input id="modelo" name="modelo" [(ngModel)]="modelo" placeholder="Ej: M123" />
        </div>
        <div>
          <label for="marca">Marca</label>
          <input id="marca" name="marca" [(ngModel)]="marca" placeholder="Ej: Sartorius" />
        </div>
        <div>
          <label for="inventario_sena">Inventario SENA</label>
          <input id="inventario_sena" name="inventario_sena" [(ngModel)]="inventario_sena" placeholder="Ej: INV-456" />
        </div>
        <div>
          <label for="ubicacion">Ubicación</label>
          <input id="ubicacion" name="ubicacion" [(ngModel)]="ubicacion" placeholder="Ej: Laboratorio 1" />
        </div>
        <div>
          <label for="acreditacion">Acreditación</label>
          <select id="acreditacion" name="acreditacion" [(ngModel)]="acreditacion">
            <option value="">Seleccione</option>
            <option value="Si">Si</option>
            <option value="No aplica">No aplica</option>
          </select>
        </div>
        <div>
          <label for="tipo_manual">Tipo de manual</label>
          <select id="tipo_manual" name="tipo_manual" [(ngModel)]="tipo_manual">
            <option value="">Seleccione</option>
            <option value="Fisico">Fisico</option>
            <option value="Digital">Digital</option>
          </select>
        </div>
        <div>
          <label for="numero_serie">Número de serie</label>
          <input id="numero_serie" name="numero_serie" [(ngModel)]="numero_serie" placeholder="Ej: SN-789" />
        </div>
        <div>
          <label for="tipo">Tipo</label>
          <select id="tipo" name="tipo" [(ngModel)]="tipo">
            <option value="">Seleccione</option>
            <option value="Gravimetría">Gravimetría</option>
            <option value="Espectrofotometría">Espectrofotometría</option>
            <option value="Potenciometría">Potenciometría</option>
            <option value="Densidad">Densidad</option>
            <option value="Óptico">Óptico</option>
            <option value="Isotérmico">Isotérmico</option>
          </select>
        </div>
        <div>
          <label for="clasificacion">Clasificación</label>
          <select id="clasificacion" name="clasificacion" [(ngModel)]="clasificacion">
            <option value="">Seleccione</option>
            <option value="Crítica">Crítica</option>
            <option value="Soporte">Soporte</option>
          </select>
        </div>
        <div>
          <label for="manual_usuario">Manual de usuario</label>
          <select id="manual_usuario" name="manual_usuario" [(ngModel)]="manual_usuario">
            <option value="">Seleccione</option>
            <option value="Si">Si</option>
            <option value="No">No</option>
          </select>
        </div>
        <div>
          <label for="fecha_adquisicion">Fecha de adquisición</label>
          <input id="fecha_adquisicion" type="date" name="fecha_adquisicion" [(ngModel)]="fecha_adquisicion" (ngModelChange)="onFechaAdquisicionChange()" />
        </div>
        <div>
          <label for="puesta_en_servicio">Puesta en servicio</label>
          <input id="puesta_en_servicio" type="date" name="puesta_en_servicio" [(ngModel)]="puesta_en_servicio" [min]="fecha_adquisicion || null" />
        </div>
        <!-- Mantenimiento del equipo -->
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">Mantenimiento</div>
        <div class="full-row">
          <label for="requerimientos_equipo">Requerimientos del equipo</label>
          <textarea id="requerimientos_equipo" name="requerimientos_equipo" [(ngModel)]="requerimientos_equipo" rows="2"></textarea>
        </div>

        <div>
          <label for="elementos_electricos">Elementos eléctricos</label>
          <select id="elementos_electricos" name="elementos_electricos" [(ngModel)]="elementos_electricos">
            <option value="">Seleccione</option>
            <option value="Si">Si</option>
            <option value="No">No</option>
          </select>
        </div>
        <div>
          <label for="voltaje">Voltaje</label>
          <input id="voltaje" name="voltaje" [(ngModel)]="voltaje" placeholder="Ej: 220V" />
        </div>
        <div>
          <label for="elementos_mecanicos">Elementos mecánicos</label>
          <select id="elementos_mecanicos" name="elementos_mecanicos" [(ngModel)]="elementos_mecanicos">
            <option value="">Seleccione</option>
            <option value="Si">Si</option>
            <option value="No">No</option>
          </select>
        </div>
        <div>
          <label for="frecuencia">Frecuencia</label>
          <input id="frecuencia" name="frecuencia" [(ngModel)]="frecuencia" placeholder="Ej: 60Hz" />
        </div>
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">Verificación</div>
        <div>
          <label for="campo_medicion">Campo de medición</label>
          <input id="campo_medicion" name="campo_medicion" [(ngModel)]="campo_medicion" placeholder="Ej: Masa" />
        </div>
        <div>
          <label for="exactitud">Exactitud</label>
          <input id="exactitud" name="exactitud" [(ngModel)]="exactitud" placeholder="Ej: ±0.01g" />
        </div>
        <div>
          <label for="sujeto_verificar">Sujeto a verificar</label>
          <select id="sujeto_verificar" name="sujeto_verificar" [(ngModel)]="sujeto_verificar">
            <option value="">Seleccione</option>
            <option value="Si">Si</option>
            <option value="No">No</option>
          </select>
        </div>
        <div>
          <label for="sujeto_calibracion">Sujeto a calibración</label>
          <select id="sujeto_calibracion" name="sujeto_calibracion" [(ngModel)]="sujeto_calibracion">
            <option value="">Seleccione</option>
            <option value="Si">Si</option>
            <option value="No">No</option>
          </select>
        </div>
        <div>
          <label for="resolucion_division">Resolución/división</label>
          <input id="resolucion_division" name="resolucion_division" [(ngModel)]="resolucion_division" placeholder="Ej: 0.1g" />
        </div>
        <div>
          <label for="sujeto_calificacion">Sujeto a calificación</label>
          <select id="sujeto_calificacion" name="sujeto_calificacion" [(ngModel)]="sujeto_calificacion">
            <option value="">Seleccione</option>
            <option value="Si">Si</option>
            <option value="No">No</option>
          </select>
        </div>
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">Accesorios</div>
        <div class="full-row">
          <label for="accesorios">Accesorios</label>
          <textarea id="accesorios" name="accesorios" [(ngModel)]="accesorios" rows="2"></textarea>
        </div>
        <div class="actions" style="width:100%; display:flex; justify-content:flex-end;">
          <button class="btn-compact" type="submit" style="width:fit-content;">Registrar equipo</button>
        </div>
      </form>
    </section>
  </div>

  <!-- Formulario de Ficha Técnica -->
  <div *ngIf="formularioActivo === 'fichaTecnica'" class="form-section">
    <h2>Registrar Ficha Técnica de Equipo</h2>
    <section>
      <form class="form-grid" (submit)="crearFichaTecnica($event)">
        
        <!-- Búsqueda de equipo con campo combinado -->
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">
          Buscar Equipo Registrado
        </div>
        <div class="full-row" style="position: relative;">
          <label for="busquedaEquipo">Buscar equipo *</label>
          <div class="campo-combinado">
            <select 
              class="select-filtro" 
              [(ngModel)]="tipoFiltro" 
              name="tipoFiltro"
              (change)="cambiarTipoFiltro(tipoFiltro)"
            >
              <option *ngFor="let opcion of opcionesFiltro" [value]="opcion.valor">
                {{ opcion.texto }}
              </option>
            </select>
            <input 
              id="busquedaEquipo" 
              name="busquedaEquipo" 
              [(ngModel)]="busquedaEquipo" 
              (input)="buscarEquipos()"
              (focus)="mostrarResultados = true"
              (blur)="onFocusOut()"
              [placeholder]="getPlaceholder()"
              autocomplete="off"
              required
              class="input-combinado"
            />
          </div>
          
          <!-- Lista de resultados -->
          <div *ngIf="mostrarResultados && busquedaEquipo.trim()" class="lista-resultados">
            <div *ngIf="equiposFiltrados.length === 0" class="sin-resultados">
              <i class="fas fa-search"></i>
              <span>No se encontraron equipos</span>
              <small>Intenta con otros términos de búsqueda</small>
            </div>
            
            <div 
              *ngFor="let equipo of equiposFiltrados" 
              class="resultado-item"
              (mousedown)="seleccionarEquipo(equipo)"
            >
              <div class="resultado-header">
                <strong class="codigo">{{ equipo.codigo_identificacion }}</strong>
                <span class="nombre">{{ equipo.nombre }}</span>

  <!-- Modal de imagen de firma -->
  <div *ngIf="firmaModalVisible" class="modal-backdrop" (click)="cerrarFirmaModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <span>Firma</span>
        <button type="button" class="modal-close" (click)="cerrarFirmaModal()">×</button>
      </div>
      <div class="modal-body">
        <img *ngIf="firmaModalSrc" [src]="firmaModalSrc" alt="Firma" class="firma-full"/>
      </div>
    </div>
  </div>
              </div>
              <div class="info-adicional">
                <span *ngIf="equipo.marca"><i class="fas fa-tag"></i> {{ equipo.marca }}</span>
                <span *ngIf="equipo.modelo"><i class="fas fa-cube"></i> {{ equipo.modelo }}</span>
                <span *ngIf="equipo.ubicacion"><i class="fas fa-map-marker-alt"></i> {{ equipo.ubicacion }}</span>
              </div>
            </div>
          </div>
          
          <!-- Equipo seleccionado -->
          <div *ngIf="equipoSeleccionado" class="equipo-seleccionado">
            <div class="seleccionado-info">
              <div class="seleccionado-content">
                <div class="seleccionado-header">
                  <i class="fas fa-check-circle"></i>
                  <strong>Equipo seleccionado:</strong>
                </div>
                <div class="seleccionado-details">
                  <span class="codigo-nombre">{{ equipoSeleccionado.codigo_identificacion }} - {{ equipoSeleccionado.nombre }}</span>
                  <div class="detalles-seleccionado">
                    <span *ngIf="equipoSeleccionado.marca"><strong>Marca:</strong> {{ equipoSeleccionado.marca }}</span>
                    <span *ngIf="equipoSeleccionado.modelo"><strong>Modelo:</strong> {{ equipoSeleccionado.modelo }}</span>
                    <span *ngIf="equipoSeleccionado.voltaje"><strong>Voltaje:</strong> {{ equipoSeleccionado.voltaje }}</span>
                  </div>
                </div>
              </div>
              <button type="button" class="btn-limpiar" (click)="limpiarBusqueda()" title="Limpiar selección">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>

          <!-- Información de ayuda -->
          <div *ngIf="!equipoSeleccionado" class="info-ayuda">
            <small>
              <i class="fas fa-info-circle"></i>
              Selecciona un equipo existente para autocompletar los campos similares automáticamente
            </small>
          </div>
        </div>

        <!-- Información básica del equipo -->
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">
          Información Básica del Equipo
        </div>
        <div>
          <label for="codigo_identificador">Código Identificador *</label>
          <input id="codigo_identificador" name="codigo_identificador" [(ngModel)]="codigo_identificador" required placeholder="Ej: FT-001" [readonly]="equipoSeleccionado" />
        </div>
        <div>
          <label for="nombre_ficha">Nombre *</label>
          <input id="nombre_ficha" name="nombre_ficha" [(ngModel)]="nombre_ficha" required placeholder="Ej: Balanza Analítica" [readonly]="equipoSeleccionado" />
        </div>
        <div>
          <label for="marca_ficha">Marca</label>
          <input id="marca_ficha" name="marca_ficha" [(ngModel)]="marca_ficha" placeholder="Ej: Sartorius" [readonly]="equipoSeleccionado" />
        </div>
        <div>
          <label for="modelo_ficha">Modelo</label>
          <input id="modelo_ficha" name="modelo_ficha" [(ngModel)]="modelo_ficha" placeholder="Ej: BSA224S" [readonly]="equipoSeleccionado" />
        </div>
        <div>
          <label for="serie_ficha">Serie</label>
          <input id="serie_ficha" name="serie_ficha" [(ngModel)]="serie_ficha" placeholder="Ej: SN123456" [readonly]="equipoSeleccionado" />
        </div>
        <div>
          <label for="fabricante">Fabricante</label>
          <input id="fabricante" name="fabricante" [(ngModel)]="fabricante" placeholder="Ej: Sartorius AG" />
        </div>
        
        <!-- El resto del formulario permanece igual -->
        <div>
          <label for="fecha_adq">Fecha de Adquisición</label>
          <input id="fecha_adq" name="fecha_adq" type="date" [(ngModel)]="fecha_adq" [readonly]="equipoSeleccionado" />
        </div>
        <div>
          <label for="uso">Uso</label>
          <input id="uso" name="uso" [(ngModel)]="uso" placeholder="Ej: Laboratorio de Química" />
        </div>
        <div>
          <label for="fecha_func">Fecha de Puesta en Funcionamiento</label>
          <input id="fecha_func" name="fecha_func" type="date" [(ngModel)]="fecha_func" [readonly]="equipoSeleccionado" />
        </div>
        <div>
          <label for="precio">Precio ($)</label>
          <input id="precio" name="precio" type="number" step="0.01" [(ngModel)]="precio" placeholder="0.00" />
        </div>
        <div>
          <label for="manual_ope">Manual de Operación</label>
          <select id="manual_ope" name="manual_ope" [(ngModel)]="manual_ope">
            <option value="">Seleccione</option>
            <option value="digital">Digital</option>
            <option value="Fisico">Físico</option>
            <option value="No">No</option>
          </select>
        </div>
        <div>
          <label for="idioma_manual">Idioma del Manual</label>
          <input id="idioma_manual" name="idioma_manual" [(ngModel)]="idioma_manual" placeholder="Ej: Español" />
        </div>

        <!-- Especificaciones de medición -->
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">
          Especificaciones de Medición
        </div>
        <div>
          <label for="magnitud">Magnitud</label>
          <input id="magnitud" name="magnitud" [(ngModel)]="magnitud" placeholder="Ej: Masa" />
        </div>
        <div>
          <label for="resolucion">Resolución</label>
          <input id="resolucion" name="resolucion" [(ngModel)]="resolucion" placeholder="Ej: 0.1 mg" />
        </div>
        <div>
          <label for="precision_med">Precisión</label>
          <input id="precision_med" name="precision_med" [(ngModel)]="precision_med" placeholder="Ej: ±0.2 mg" />
        </div>
        <div>
          <label for="exactitud_ficha">Exactitud</label>
          <input id="exactitud_ficha" name="exactitud_ficha" [(ngModel)]="exactitud_ficha" placeholder="Ej: ±0.1%" />
        </div>
        <div>
          <label for="rango_de_medicion">Rango de Medición</label>
          <input id="rango_de_medicion" name="rango_de_medicion" [(ngModel)]="rango_de_medicion" placeholder="Ej: 0-220 g" />
        </div>
        <div>
          <label for="rango_de_uso">Rango de Uso</label>
          <input id="rango_de_uso" name="rango_de_uso" [(ngModel)]="rango_de_uso" placeholder="Ej: 10-210 g" />
        </div>

        <!-- Especificaciones eléctricas -->
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">
          Especificaciones Eléctricas
        </div>
        <div>
          <label for="voltaje_ficha">Voltaje</label>
          <input id="voltaje_ficha" name="voltaje_ficha" [(ngModel)]="voltaje_ficha" placeholder="Ej: 220V" [readonly]="equipoSeleccionado" />
        </div>
        <div>
          <label for="potencia">Potencia</label>
          <input id="potencia" name="potencia" [(ngModel)]="potencia" placeholder="Ej: 15W" />
        </div>
        <div>
          <label for="amperaje">Amperaje</label>
          <input id="amperaje" name="amperaje" [(ngModel)]="amperaje" placeholder="Ej: 1.5A" />
        </div>
        <div>
          <label for="frecuencia_ficha">Frecuencia</label>
          <input id="frecuencia_ficha" name="frecuencia_ficha" [(ngModel)]="frecuencia_ficha" placeholder="Ej: 60Hz" [readonly]="equipoSeleccionado" />
        </div>

        <!-- Dimensiones físicas -->
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">
          Dimensiones Físicas
        </div>
        <div>
          <label for="ancho">Ancho (cm)</label>
          <input id="ancho" name="ancho" type="number" step="0.01" [(ngModel)]="ancho" placeholder="0.00" />
        </div>
        <div>
          <label for="alto">Alto (cm)</label>
          <input id="alto" name="alto" type="number" step="0.01" [(ngModel)]="alto" placeholder="0.00" />
        </div>
        <div>
          <label for="profundidad">Profundidad (cm)</label>
          <input id="profundidad" name="profundidad" type="number" step="0.01" [(ngModel)]="profundidad" placeholder="0.00" />
        </div>
        <div>
          <label for="peso_kg">Peso (kg)</label>
          <input id="peso_kg" name="peso_kg" type="number" step="0.01" [(ngModel)]="peso_kg" placeholder="0.00" />
        </div>

        <!-- Condiciones ambientales -->
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">
          Condiciones Ambientales
        </div>
        <div>
          <label for="temperatura_c">Temperatura (°C)</label>
          <input id="temperatura_c" name="temperatura_c" type="number" step="0.01" [(ngModel)]="temperatura_c" placeholder="Ej: 25.00" />
        </div>
        <div>
          <label for="humedad_porcentaje">Humedad (%)</label>
          <input id="humedad_porcentaje" name="humedad_porcentaje" type="number" step="0.01" [(ngModel)]="humedad_porcentaje" placeholder="Ej: 50.00" />
        </div>
        <div class="full-row">
          <label for="limitaciones_e_interferencias">Limitaciones e Interferencias</label>
          <textarea id="limitaciones_e_interferencias" name="limitaciones_e_interferencias" [(ngModel)]="limitaciones_e_interferencias" rows="3"></textarea>
        </div>
        <div class="full-row">
          <label for="otros">Otros</label>
          <textarea id="otros" name="otros" [(ngModel)]="otros" rows="2"></textarea>
        </div>

        <!-- Información del proveedor -->
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">
          Información del Proveedor
        </div>
        <div>
          <label for="proveedor">Proveedor</label>
          <input id="proveedor" name="proveedor" [(ngModel)]="proveedor" placeholder="Ej: Distribuidora XYZ" />
        </div>
        <div>
          <label for="email">Email</label>
          <input id="email" name="email" type="email" [(ngModel)]="email" placeholder="Ej: contacto@proveedor.com" />
        </div>
        <div>
          <label for="telefono">Teléfono</label>
          <input id="telefono" name="telefono" [(ngModel)]="telefono" placeholder="Ej: +57 123 456 7890" />
        </div>
        <div>
          <label for="fecha_de_instalacion">Fecha de Instalación</label>
          <input id="fecha_de_instalacion" name="fecha_de_instalacion" type="date" [(ngModel)]="fecha_de_instalacion" />
        </div>
        <div>
          <label for="garantia">Garantía</label>
          <input id="garantia" name="garantia" [(ngModel)]="garantia" placeholder="Ej: 2 años" />
        </div>
        <div class="full-row">
          <label for="alcance_del_servicio">Alcance del Servicio</label>
          <textarea id="alcance_del_servicio" name="alcance_del_servicio" [(ngModel)]="alcance_del_servicio" rows="3"></textarea>
        </div>

        <!-- Campos finales -->
        <div class="form-section-title" style="grid-column: 1 / -1; font-weight: bold; margin-top: 1.5rem;">
          Información Final
        </div>
        <div class="full-row">
          <label for="accesorios_ficha">Accesorios</label>
          <textarea id="accesorios_ficha" name="accesorios_ficha" [(ngModel)]="accesorios_ficha" rows="2"></textarea>
        </div>
        <div class="full-row">
          <label for="especificaciones_software">Especificaciones de Software</label>
          <textarea id="especificaciones_software" name="especificaciones_software" [(ngModel)]="especificaciones_software" rows="3"></textarea>
        </div>
        <div class="full-row">
          <label for="observaciones_ficha">Observaciones</label>
          <textarea id="observaciones_ficha" name="observaciones_ficha" [(ngModel)]="observaciones_ficha" rows="3"></textarea>
        </div>
        <div>
          <label for="recibido_por">Recibido Por</label>
          <input id="recibido_por" name="recibido_por" [(ngModel)]="recibido_por" placeholder="Nombre completo" />
        </div>
        <div>
          <label for="firma">Firma (imagen)</label>
          <input id="firma" name="firma" type="file" accept="image/*" (change)="onFirmaChange($event)" />
          <small>Peso máximo 5MB. Formatos: JPG, PNG.</small>
        </div>
        <div>
          <label for="fecha_ficha">Fecha</label>
          <input id="fecha_ficha" name="fecha_ficha" type="date" [(ngModel)]="fecha_ficha" />
        </div>

        <div class="actions" style="width:100%; display:flex; justify-content:flex-end;">
          <button class="btn-compact" type="submit" style="width:fit-content;">Registrar Ficha Técnica</button>
        </div>
      </form>
    </section>
  </div>

  <!-- Formulario de Historial -->
  <div *ngIf="formularioActivo === 'historial'" class="form-section">
    <h2>Registrar historial de equipo</h2>
    <section>
      <form class="form-grid" (submit)="crearHistorial($event)">
        <!-- Equipo primero -->
        <div>
          <label for="codigo_identificacion">Equipo *</label>
          <select #selHistorial id="codigo_identificacion" name="codigo_identificacion" [(ngModel)]="codigo_identificacion" (ngModelChange)="onSeleccionEquipoHistorialChange($event)">
            <option value="" disabled selected>Seleccione un equipo</option>
            <option *ngFor="let equipo of equiposRegistrados" [value]="equipo.codigo_identificacion">
              {{ equipo.codigo_identificacion }} - {{ equipo.nombre }}
            </option>
          </select>
        </div>
        
        <!-- Consecutivo readonly -->
        <div>
          <label for="consecutivo">Consecutivo *</label>
          <input id="consecutivo" name="consecutivo" [value]="consecutivoHistorialSig() ?? ''" readonly placeholder="Auto" />
        </div>
        
        <div>
          <label for="fecha">Fecha</label>
          <input id="fecha" name="fecha" type="date" [(ngModel)]="fecha" />
        </div>
        <div>
          <label for="tipo_historial">Tipo historial</label>
          <input id="tipo_historial" name="tipo_historial" [(ngModel)]="tipo_historial" placeholder="Ej: Calibración, Mantenimiento" />
        </div>
        <div>
          <label for="codigo_registro">Código registro</label>
          <input id="codigo_registro" name="codigo_registro" [(ngModel)]="codigo_registro" placeholder="Ej: REG-001" />
        </div>
        <div>
          <label for="tolerancia_g">Tolerancia (g)</label>
          <input id="tolerancia_g" name="tolerancia_g" type="number" step="0.0001" [(ngModel)]="tolerancia_g" />
        </div>
        <div>
          <label for="tolerancia_error_g">Tolerancia error (g)</label>
          <input id="tolerancia_error_g" name="tolerancia_error_g" type="number" step="0.0001" [(ngModel)]="tolerancia_error_g" />
        </div>
        <div>
          <label for="incertidumbre_u">Incertidumbre (u)</label>
          <input id="incertidumbre_u" name="incertidumbre_u" type="number" step="0.0001" [(ngModel)]="incertidumbre_u" />
        </div>
        <div>
          <label for="realizo">Realizó</label>
          <input id="realizo" name="realizo" [(ngModel)]="realizo" placeholder="Nombre de quien realizó" />
        </div>
        <div>
          <label for="superviso">Supervisó</label>
          <input id="superviso" name="superviso" [(ngModel)]="superviso" placeholder="Nombre de quien supervisó" />
        </div>
        <div class="full-row">
          <label for="observaciones">Observaciones</label>
          <textarea id="observaciones" name="observaciones" [(ngModel)]="observaciones" rows="2"></textarea>
        </div>
        <div class="actions">
          <button class="btn-compact" type="submit">Registrar historial</button>
        </div>
      </form>
    </section>
  </div>

  <!-- Formulario de Intervalo -->
  <div *ngIf="formularioActivo === 'intervalo'" class="form-section">
    <h2>Registrar intervalo de equipo</h2>
    <section>
      <form class="form-grid" (submit)="crearIntervalo($event)">
        <!-- Equipo primero -->
        <div>
          <label for="codigo_identificacion_intervalo">Equipo *</label>
          <select #selIntervalo id="codigo_identificacion_intervalo" name="codigo_identificacion_intervalo" [(ngModel)]="codigo_identificacion_intervalo" (ngModelChange)="onSeleccionEquipoIntervaloChange($event)">
            <option value="" disabled selected>Seleccione un equipo</option>
            <option *ngFor="let equipo of equiposRegistrados" [value]="equipo.codigo_identificacion">
              {{ equipo.codigo_identificacion }} - {{ equipo.nombre }}
            </option>
          </select>
        </div>
        
        <!-- Consecutivo readonly -->
        <div>
          <label for="consecutivo_intervalo">Consecutivo *</label>
          <input id="consecutivo_intervalo" name="consecutivo_intervalo" [value]="consecutivoIntervaloSig() ?? ''" readonly placeholder="Auto" />
        </div>
        
        <div>
          <label for="unidad_nominal_g">Unidad nominal (g)</label>
          <input id="unidad_nominal_g" name="unidad_nominal_g" type="number" step="0.0001" [(ngModel)]="unidad_nominal_g" />
        </div>
        <div>
          <label for="calibracion_1">Calibración 1 (Penultima)</label>
          <input id="calibracion_1" name="calibracion_1" [(ngModel)]="calibracion_1" placeholder="Ej: Certificado 1" />
        </div>
        <div>
          <label for="fecha_c1">Fecha calibración 1</label>
          <input id="fecha_c1" name="fecha_c1" type="date" [(ngModel)]="fecha_c1" (ngModelChange)="calcularDiferenciaDias()" />
        </div>
        <div>
          <label for="error_c1_g">Error calibración 1 (g)</label>
          <input id="error_c1_g" name="error_c1_g" type="number" step="0.0001" [(ngModel)]="error_c1_g" (ngModelChange)="calcularDesviacion()" />
        </div>
        <div>
          <label for="calibracion_2">Calibración 2 (actual)</label>
          <input id="calibracion_2" name="calibracion_2" [(ngModel)]="calibracion_2" placeholder="Ej: Certificado 2" />
        </div>
        <div>
          <label for="fecha_c2">Fecha calibración 2</label>
          <input id="fecha_c2" name="fecha_c2" type="date" [(ngModel)]="fecha_c2" (ngModelChange)="calcularDiferenciaDias()" [attr.min]="fecha_c1 || null" />
        </div>
        <div>
          <label for="error_c2_g">Error calibración 2 (g)</label>
          <input id="error_c2_g" name="error_c2_g" type="number" step="0.0001" [(ngModel)]="error_c2_g" (ngModelChange)="calcularDesviacion()" />
        </div>
        <div>
          <label for="diferencia_dias">Diferencia días</label>
          <input id="diferencia_dias" name="diferencia_dias" type="number" [(ngModel)]="diferencia_dias" readonly />
        </div>
        <div>
          <label for="desviacion">Desviación</label>
          <input id="desviacion" name="desviacion" type="number" step="0.0001" [(ngModel)]="desviacion" readonly />
        </div>
        <div>
          <label for="deriva">Deriva</label>
          <input id="deriva" name="deriva" type="number" step="0.0001" [(ngModel)]="deriva" readonly />
        </div>
        <div>
          <label for="tolerancia_g_intervalo">Tolerancia (g)</label>
          <input id="tolerancia_g_intervalo" name="tolerancia_g_intervalo" type="number" step="0.0001" [(ngModel)]="tolerancia_g_intervalo" (ngModelChange)="calcularIntervaloCalibDias()" />
        </div>
        <div>
          <label for="intervalo_calibraciones_dias">Intervalo calibraciones (días)</label>
          <input id="intervalo_calibraciones_dias" name="intervalo_calibraciones_dias" type="number" [(ngModel)]="intervalo_calibraciones_dias" readonly />
        </div>
        <div>
          <label for="intervalo_calibraciones_anios">Intervalo calibraciones (años)</label>
          <input id="intervalo_calibraciones_anios" name="intervalo_calibraciones_anios" type="number" step="0.0001" [(ngModel)]="intervalo_calibraciones_anios" readonly />
        </div>
        <div class="actions">
          <button class="btn-compact" type="submit">Registrar intervalo</button>
        </div>
      </form>
    </section>
  </div>

  <!-- Lista de Equipos -->
  <div class="form-section">
    <h2>
      <i class="fas fa-list"></i>
      | Lista de Equipos Registrados
    </h2>
    
    <div *ngIf="cargandoEquipos" class="sin-equipos">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Cargando equipos...</p>
    </div>
    
    <div *ngIf="!cargandoEquipos && equiposRegistrados.length === 0" class="sin-equipos">
      <i class="fas fa-inbox"></i>
      <p>No hay equipos registrados</p>
      <button class="btn-compact" (click)="toggleFormulario('hojaVida'); $event.stopPropagation()">
        <i class="fas fa-plus"></i> Registrar primer equipo
      </button>
    </div>

    <div *ngIf="!cargandoEquipos && equiposRegistrados.length > 0" class="equipos-grid">
      <article *ngFor="let equipo of equiposRegistrados" class="equipo-card" (click)="toggleDetalleEquipo(equipo.codigo_identificacion)">
        <div class="card-top">
          <div class="tags">
            <span class="tag"><strong>Código:</strong> {{ equipo.codigo_identificacion }}</span>
            <span class="tag"><strong>Marca:</strong> {{ equipo.marca || '—' }}</span>
            <span class="tag"><strong>Modelo:</strong> {{ equipo.modelo || '—' }}</span>
            <span class="tag"><strong>Serie:</strong> {{ equipo.numero_serie || '—' }}</span>
            <span class="tag"><strong>Clasificación:</strong> {{ equipo.clasificacion || '—' }}</span>
          </div>
          <div class="pdf-actions" (click)="$event.stopPropagation()">
            <button type="button" class="pdf-btn edit" title="Editar equipo" (click)="abrirEditarEquipo(equipo, $event)">
              <svg viewBox="0 0 24 24" class="icon">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="currentColor" />
                <path d="M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor" />
              </svg>
            </button>
            <button type="button" class="pdf-btn delete" title="Eliminar equipo" (click)="eliminarEquipo(equipo, $event)">
              <svg viewBox="0 0 24 24" class="icon">
                <path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </button>
          </div>
        </div>
        <div class="card-header-row">
          <div class="card-name" [title]="equipo.nombre">
            <div class="name-line">{{ equipo.nombre }}</div>
            <div class="meta-line">
              <span class="chip">Tipo: {{ equipo.tipo || 'Sin tipo' }}</span>
              <span class="chip">Ubicación: {{ equipo.ubicacion || '—' }}</span>
              <span class="chip">Acreditación: {{ equipo.acreditacion || 'Sin acreditación' }}</span>
            </div>
            <div class="card-right-controls" (click)="$event.stopPropagation()">
              <div class="card-controls-inner">
                <div class="pdf-field">
                  <svg class="pdf-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <rect x="3" y="2" width="18" height="20" rx="5" fill="#fff" stroke="#e5e7eb" stroke-width="1.6" />
                    <rect x="7" y="13.5" width="10" height="6" rx="3" fill="#ff3b30"/>
                    <text x="9" y="17.2" font-size="5.5" fill="#fff" font-weight="600">PDF</text>
                  </svg>

                  <select class="pdf-select" [(ngModel)]="selectedPdfByEquipo[equipo.codigo_identificacion]" [class.placeholder]="!selectedPdfByEquipo[equipo.codigo_identificacion]">
                    <option [ngValue]="null" disabled>Seleccionar PDF...</option>
                    <option *ngFor="let pdf of (pdfListByEquipo[equipo.codigo_identificacion] || [])" [value]="pdf.url" [title]="pdf.name">{{ pdf.displayName || pdf.name }}</option>
                    <option *ngIf="!(pdfListByEquipo[equipo.codigo_identificacion] || []).length" [ngValue]="null" disabled>Sin archivos</option>
                  </select>

                  <button class="btn view pdf-action" (click)="openPdf(equipo.codigo_identificacion, $event)">Ver</button>
                  <button class="btn delete pdf-action eliminar" (click)="deletePdf(equipo.codigo_identificacion, $event)">Eliminar</button>
                  <button class="btn add pdf-action" (click)="mostrarMenuCategoriaPdf(equipo.codigo_identificacion, $event)">Añadir</button>
                </div>

                <!-- Menú de categorías de PDF (se muestra al hacer clic en Añadir) -->
                <ul *ngIf="menuCategoriaPdfVisible[equipo.codigo_identificacion]" class="categoria-pdf-menu" (click)="$event.stopPropagation()">
                  <li (click)="iniciarUpload(equipo.codigo_identificacion, 'Manual de usuario', $event)">Manual de usuario</li>
                  <li (click)="iniciarUpload(equipo.codigo_identificacion, 'Certificados de calificación', $event)">Certificados de calificación</li>
                  <li (click)="iniciarUpload(equipo.codigo_identificacion, 'Certificados de verificación', $event)">Certificados de verificación</li>
                  <li (click)="iniciarUpload(equipo.codigo_identificacion, 'Certificados de calibración', $event)">Certificados de calibración</li>
                  <li (click)="iniciarUpload(equipo.codigo_identificacion, 'Certificados de mantenimiento', $event)">Certificados de mantenimiento</li>
                  <li (click)="iniciarUpload(equipo.codigo_identificacion, 'Ficha técnica de especificaciones', $event)">Ficha técnica de especificaciones</li>
                </ul>
            </div>
            </div>
          </div>
        </div>
        <div *ngIf="equipoExpandido === equipo.codigo_identificacion" class="equipo-detalles">
          <!-- Menú de pestañas para información del equipo -->
          <div class="equipo-tabs-menu">
            <button type="button" class="tab-btn" *ngFor="let tab of equipoTabs" [class.active]="activeTab[equipo.codigo_identificacion] === tab.key" (click)="selectTab(equipo.codigo_identificacion, tab.key); $event.stopPropagation()">
              {{ tab.label }}
              <span *ngIf="tab.key === 'historial' || tab.key === 'intervalo'" class="tab-count" aria-hidden="true">{{ getTabCount(equipo, tab.key) }}</span>
            </button>
          </div>
          <div class="equipo-info-card" [attr.aria-labelledby]="'info-equipo-title-' + equipo.codigo_identificacion" (click)="$event.stopPropagation()">
            <div class="equipo-info-card-header">
              <span class="equipo-info-card-title" [attr.id]="'info-equipo-title-' + equipo.codigo_identificacion">Información del Equipo</span>
            </div>
            <div class="equipo-info-card-body">
              <!-- Contenido de pestañas -->
              <ng-container [ngSwitch]="activeTab[equipo.codigo_identificacion]">
                <div *ngSwitchCase="'hojaVida'">
                  <!-- Datos Generales -->
                  <div class="seccion-titulo">Datos Generales</div>
                  <div class="detalle-grid-compacto">
                    <div class="detalle-item"><span class="detalle-label">Inventario SENA</span><span>{{ equipo.inventario_sena || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Tipo Manual</span><span>{{ equipo.tipo_manual || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Manual Usuario</span><span>{{ equipo.manual_usuario || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Puesta en Servicio</span><span>{{ equipo.puesta_en_servicio ? (equipo.puesta_en_servicio | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Fecha Adquisición</span><span>{{ equipo.fecha_adquisicion ? (equipo.fecha_adquisicion | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                    <div class="detalle-item detalle-item-full"><span class="detalle-label">Requerimientos</span><span>{{ equipo.requerimientos_equipo || 'N/A' }}</span></div>
                    <div class="detalle-item detalle-item-full"><span class="detalle-label">Accesorios</span><span>{{ equipo.accesorios || 'N/A' }}</span></div>
                  </div>

                  <!-- Especificaciones Eléctricas y Mecánicas -->
                  <div class="seccion-titulo">Especificaciones Eléctricas y Mecánicas</div>
                  <div class="detalle-grid-compacto">
                    <div class="detalle-item"><span class="detalle-label">Elementos Eléctricos</span><span>{{ equipo.elementos_electricos || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Voltaje</span><span>{{ equipo.voltaje || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Elementos Mecánicos</span><span>{{ equipo.elementos_mecanicos || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Frecuencia</span><span>{{ equipo.frecuencia || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Potencia</span><span>{{ equipo.potencia || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Amperaje</span><span>{{ equipo.amperaje || 'N/A' }}</span></div>
                  </div>

                  <!-- Verificación y Calibración -->
                  <div class="seccion-titulo">Verificación y Calibración</div>
                  <div class="detalle-grid-compacto">
                    <div class="detalle-item"><span class="detalle-label">Campo Medición</span><span>{{ equipo.campo_medicion || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Exactitud</span><span>{{ equipo.exactitud || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Sujeto Verificar</span><span>{{ equipo.sujeto_verificar || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Sujeto Calibración</span><span>{{ equipo.sujeto_calibracion || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Resolución/División</span><span>{{ equipo.resolucion_division || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Sujeto Calificación</span><span>{{ equipo.sujeto_calificacion || 'N/A' }}</span></div>
                  </div>

                  <!-- Ficha Técnica - Información Básica -->
                  <div class="seccion-titulo">Información de Ficha Técnica</div>
                  <div class="detalle-grid-compacto">
                    <div class="detalle-item"><span class="detalle-label">Fabricante</span><span>{{ equipo.fabricante || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Fecha Adquisición FT</span><span>{{ equipo.fecha_adq ? (equipo.fecha_adq | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Uso</span><span>{{ equipo.uso || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Fecha Funcionamiento</span><span>{{ equipo.fecha_func ? (equipo.fecha_func | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Precio</span><span>{{ equipo.precio || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Manual Operación</span><span>{{ equipo.manual_ope || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Idioma Manual</span><span>{{ equipo.idioma_manual || 'N/A' }}</span></div>
                  </div>

                  <!-- Especificaciones de Medición -->
                  <div class="seccion-titulo">Especificaciones de Medición</div>
                  <div class="detalle-grid-compacto">
                    <div class="detalle-item"><span class="detalle-label">Magnitud</span><span>{{ equipo.magnitud || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Resolución</span><span>{{ equipo.resolucion || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Precisión Medición</span><span>{{ equipo.precision_med || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Rango de Medición</span><span>{{ equipo.rango_de_medicion || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Rango de Uso</span><span>{{ equipo.rango_de_uso || 'N/A' }}</span></div>
                  </div>

                  <!-- Dimensiones Físicas -->
                  <div class="seccion-titulo">Dimensiones Físicas</div>
                  <div class="detalle-grid-compacto">
                    <div class="detalle-item"><span class="detalle-label">Ancho (cm)</span><span>{{ equipo.ancho || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Alto (cm)</span><span>{{ equipo.alto || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Profundidad (cm)</span><span>{{ equipo.profundidad || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Peso (kg)</span><span>{{ equipo.peso_kg || 'N/A' }}</span></div>
                  </div>

                  <!-- Condiciones Ambientales -->
                  <div class="seccion-titulo">Condiciones Ambientales</div>
                  <div class="detalle-grid-compacto">
                    <div class="detalle-item"><span class="detalle-label">Temperatura (°C)</span><span>{{ equipo.temperatura_c || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Humedad (%)</span><span>{{ equipo.humedad_porcentaje || 'N/A' }}</span></div>
                    <div class="detalle-item detalle-item-full"><span class="detalle-label">Limitaciones/Interferencias</span><span>{{ equipo.limitaciones_e_interferencias || 'N/A' }}</span></div>
                    <div class="detalle-item detalle-item-full"><span class="detalle-label">Otros</span><span>{{ equipo.otros || 'N/A' }}</span></div>
                  </div>

                  <!-- Especificaciones Técnicas del Software -->
                  <div class="seccion-titulo">Especificaciones Técnicas del Software</div>
                  <div class="detalle-grid-compacto">
                    <div class="detalle-item detalle-item-full"><span class="detalle-label">Especificaciones Software</span><span>{{ equipo.especificaciones_software || 'N/A' }}</span></div>
                  </div>

                  <!-- Información del Proveedor -->
                  <div class="seccion-titulo">Información del Proveedor</div>
                  <div class="detalle-grid-compacto">
                    <div class="detalle-item"><span class="detalle-label">Proveedor</span><span>{{ equipo.proveedor || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Email</span><span>{{ equipo.email || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Teléfono</span><span>{{ equipo.telefono || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Fecha Instalación</span><span>{{ equipo.fecha_de_instalacion ? (equipo.fecha_de_instalacion | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                    <div class="detalle-item detalle-item-full"><span class="detalle-label">Alcance Servicio</span><span>{{ equipo.alcance_del_servicio || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Garantía</span><span>{{ equipo.garantia || 'N/A' }}</span></div>
                    <div class="detalle-item detalle-item-full"><span class="detalle-label">Observaciones</span><span>{{ equipo.observaciones || 'N/A' }}</span></div>
                    <div class="detalle-item"><span class="detalle-label">Recibido por</span><span>{{ equipo.recibido_por || 'N/A' }}</span></div>
                    <div class="detalle-item">
                      <span class="detalle-label">Cargo y Firma</span>
                      <span class="firma-actions firma-center">
                        <a 
                          *ngIf="(equipo.codigo_identificador || equipo.codigo_identificacion)"
                          [href]="API_EQUIPOS + '/firma/' + (equipo.codigo_identificador || equipo.codigo_identificacion)"
                          target="_blank" 
                          rel="noopener noreferrer"
                          class="icon-eye-link"
                          title="Abrir firma en nueva pestaña"
                        >
                          <i class="fas fa-eye icon-eye"></i>
                        </a>
                        <span *ngIf="!(equipo.codigo_identificador || equipo.codigo_identificacion)">N/A</span>
                      </span>
                    </div>
                    <div class="detalle-item"><span class="detalle-label">Fecha</span><span>{{ equipo.fecha ? (equipo.fecha | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                  </div>
                </div>
                <div *ngSwitchCase="'historial'">
                  <div *ngIf="historialPorEquipo[equipo.codigo_identificacion] && historialPorEquipo[equipo.codigo_identificacion].length > 0; else sinHistorial">
                    <div class="historial-records-container">
                      <div *ngFor="let registro of historialPorEquipo[equipo.codigo_identificacion]" class="historial-record-card">
                        <div class="historial-header" (click)="toggleHistorialRegistro(equipo.codigo_identificacion, registro.consecutivo)">
                          <span class="historial-consecutivo">
                            <i class="fas" [ngClass]="historialExpandido[equipo.codigo_identificacion + '_' + registro.consecutivo] ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                            Registro #{{ registro.consecutivo }}
                          </span>
                          <span class="historial-fecha">{{ registro.fecha ? (registro.fecha | date: 'yyyy/MM/dd') : 'N/A' }}</span>
                        </div>
                        <div class="historial-body" *ngIf="historialExpandido[equipo.codigo_identificacion + '_' + registro.consecutivo]">
                          <div class="historial-grid">
                            <div class="historial-item"><span class="historial-label">Tipo Historial:</span><span>{{ registro.tipo_historial || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Código Registro:</span><span>{{ registro.codigo_registro || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Tolerancia (g):</span><span>{{ registro.tolerancia_g || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Error Tolerancia (g):</span><span>{{ registro.tolerancia_error_g || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Incertidumbre (u):</span><span>{{ registro.incertidumbre_u || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Realizó:</span><span>{{ registro.realizo || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Supervisó:</span><span>{{ registro.superviso || 'N/A' }}</span></div>
                            <div class="historial-item historial-item-full" *ngIf="registro.observaciones"><span class="historial-label">Observaciones:</span><span>{{ registro.observaciones }}</span></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <ng-template #sinHistorial>
                    <div class="no-historial-message">
                      <i class="fas fa-history"></i>
                      <p>No hay registros de historial para este equipo</p>
                    </div>
                  </ng-template>
                </div>
                <div *ngSwitchCase="'intervalo'">
                  <div *ngIf="intervaloPorEquipo[equipo.codigo_identificacion] && intervaloPorEquipo[equipo.codigo_identificacion].length > 0; else sinIntervalo">
                    <div class="historial-records-container">
                      <div *ngFor="let registro of intervaloPorEquipo[equipo.codigo_identificacion]" class="historial-record-card">
                        <div class="historial-header" (click)="toggleIntervaloRegistro(equipo.codigo_identificacion, registro.consecutivo)">
                          <span class="historial-consecutivo">
                            <i class="fas" [ngClass]="intervaloExpandido[equipo.codigo_identificacion + '_' + registro.consecutivo] ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                            Registro #{{ registro.consecutivo }}
                          </span>
                          <span class="historial-fecha">Unidad: {{ registro.unidad_nominal_g || 'N/A' }}g</span>
                        </div>
                        <div class="historial-body" *ngIf="intervaloExpandido[equipo.codigo_identificacion + '_' + registro.consecutivo]">
                          <div class="historial-grid">
                            <div class="historial-item"><span class="historial-label">Unidad Nominal (g):</span><span>{{ registro.unidad_nominal_g || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Calibración 1:</span><span>{{ registro.calibracion_1 || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Fecha Cal. 1:</span><span>{{ registro.fecha_c1 ? (registro.fecha_c1 | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Error Cal. 1 (g):</span><span>{{ registro.error_c1_g || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Calibración 2:</span><span>{{ registro.calibracion_2 || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Fecha Cal. 2:</span><span>{{ registro.fecha_c2 ? (registro.fecha_c2 | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Error Cal. 2 (g):</span><span>{{ registro.error_c2_g || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Diferencia Días:</span><span>{{ registro.diferencia_dias || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Desviación:</span><span>{{ registro.desviacion || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Deriva:</span><span>{{ registro.deriva || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Tolerancia (g):</span><span>{{ registro.tolerancia_g || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Intervalo Cal. (días):</span><span>{{ registro.intervalo_calibraciones_dias || 'N/A' }}</span></div>
                            <div class="historial-item"><span class="historial-label">Intervalo Cal. (años):</span><span>{{ registro.intervalo_calibraciones_anios || 'N/A' }}</span></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <ng-template #sinIntervalo>
                    <div class="no-historial-message">
                      <i class="fas fa-calendar-alt"></i>
                      <p>No hay registros de intervalo para este equipo</p>
                    </div>
                  </ng-template>
                </div>
                <div *ngSwitchDefault>
                  <div class="detalle-grid-compacto"><span>Seleccione una pestaña</span></div>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </article>
    </div>

    <!-- Edit Equipo Modal (tabs: Hoja de vida, Ficha técnica, Historial, Intervalo) -->
    <div *ngIf="editModalVisible || editModalClosing" class="modal-overlay" [class.closing]="editModalClosing" (click)="closeEditEquipoModal()">
      <div class="edit-modal" [class.closing]="editModalClosing" (click)="$event.stopPropagation()">
        <h3>Editar Equipo</h3>

        <div class="equipo-tabs-menu">
          <button type="button" class="tab-btn" [class.active]="editModalActiveTab === 'hojaVida'" (click)="editModalActiveTab = 'hojaVida'">Hoja de vida</button>
          <button type="button" class="tab-btn" [class.active]="editModalActiveTab === 'fichaTecnica'" (click)="editModalActiveTab = 'fichaTecnica'">Ficha técnica</button>
          <button type="button" class="tab-btn" [class.active]="editModalActiveTab === 'historial'" (click)="editModalActiveTab = 'historial'">Historial</button>
          <button type="button" class="tab-btn" [class.active]="editModalActiveTab === 'intervalo'" (click)="editModalActiveTab = 'intervalo'">Intervalo</button>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button type="button" class="tab-btn" (click)="saveAllEditEquipo()">Guardar</button>
          </div>
        </div>

        <div style="margin-top:12px" class="edit-modal-body">
          <div *ngIf="editModalActiveTab === 'hojaVida'">
            <div class="form-grid">
              <div>
                <label>Código</label>
                <input [(ngModel)]="codigo_identificacion" />
              </div>
              <div>
                <label>Nombre</label>
                <input [(ngModel)]="nombre" />
              </div>
              <div>
                <label>Marca</label>
                <input [(ngModel)]="marca" />
              </div>
              <div>
                <label>Modelo</label>
                <input [(ngModel)]="modelo" />
              </div>
              <div>
                <label>Serie</label>
                <input [(ngModel)]="numero_serie" />
              </div>
              <div>
                <label>Inventario SENA</label>
                <input [(ngModel)]="inventario_sena" />
              </div>
              <div>
                <label>Ubicación</label>
                <input [(ngModel)]="ubicacion" />
              </div>
              <div>
                <label>Acreditación</label>
                <select [(ngModel)]="acreditacion">
                  <option value="">Ninguna</option>
                  <option value="Acreditado">Acreditado</option>
                  <option value="No acreditado">No acreditado</option>
                </select>
              </div>
              <div>
                <label>Tipo de manual</label>
                <select [(ngModel)]="tipo_manual">
                  <option value="">Seleccione</option>
                  <option value="Manual de usuario">Manual de usuario</option>
                  <option value="Ficha técnica">Ficha técnica</option>
                </select>
              </div>
              <div>
                <label>Manual de usuario</label>
                <select [(ngModel)]="manual_usuario">
                  <option value="">Sin manual</option>
                  <option value="Sí">Sí</option>
                </select>
              </div>
              <div>
                <label>Puesta en servicio</label>
                <input type="date" [(ngModel)]="puesta_en_servicio" />
              </div>
              <div>
                <label>Fecha adquisición</label>
                <input type="date" [(ngModel)]="fecha_adquisicion" />
              </div>
              <div style="grid-column: 1 / -1;">
                <label>Requerimientos del equipo</label>
                <textarea [(ngModel)]="requerimientos_equipo"></textarea>
              </div>
              <div style="grid-column: 1 / -1;">
                <label>Accesorios</label>
                <textarea [(ngModel)]="accesorios"></textarea>
              </div>
            </div>
          </div>

          <div *ngIf="editModalActiveTab === 'fichaTecnica'">
            <div class="form-grid">
              <div>
                <label>Clasificación</label>
                <input [(ngModel)]="clasificacion" />
              </div>
              <div>
                <label>Tipo</label>
                <input [(ngModel)]="tipo" />
              </div>
              <div>
                <label>Voltaje</label>
                <input [(ngModel)]="voltaje" />
              </div>
              <div>
                <label>Frecuencia</label>
                <input [(ngModel)]="frecuencia" />
              </div>
              <div>
                <label>Campo de medición</label>
                <input [(ngModel)]="campo_medicion" />
              </div>
              <div>
                <label>Exactitud</label>
                <input [(ngModel)]="exactitud" />
              </div>
            </div>
          </div>

          <div *ngIf="editModalActiveTab === 'historial'">
            <!-- List existing historial registros for the editing equipo -->
            <div *ngIf="editingEquipoCodigo && historialPorEquipo[editingEquipoCodigo] && historialPorEquipo[editingEquipoCodigo].length > 0; else noModalHistorial">
              <div class="historial-records-container">
                <div *ngFor="let registro of historialPorEquipo[editingEquipoCodigo]" class="historial-record-card">
                  <div class="historial-header" (click)="toggleHistorialRegistro(editingEquipoCodigo, registro.consecutivo)">
                    <span class="historial-consecutivo">
                      <i class="fas" [ngClass]="historialExpandido[editingEquipoCodigo + '_' + registro.consecutivo] ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                      Registro #{{ registro.consecutivo }}
                    </span>
                    <span class="historial-fecha">{{ registro.fecha ? (registro.fecha | date: 'yyyy/MM/dd') : 'N/A' }}</span>
                  </div>
                  <div class="historial-body" *ngIf="historialExpandido[editingEquipoCodigo + '_' + registro.consecutivo]">
                    <div *ngIf="registro._edit; else viewHistorial">
                      <div class="form-grid">
                        <div><label>Tipo</label><input [(ngModel)]="registro._edit.tipo_historial" /></div>
                        <div><label>Código Registro</label><input [(ngModel)]="registro._edit.codigo_registro" /></div>
                        <div><label>Fecha</label><input type="date" [(ngModel)]="registro._edit.fecha" /></div>
                        <div><label>Realizó</label><input [(ngModel)]="registro._edit.realizo" /></div>
                        <div><label>Supervisó</label><input [(ngModel)]="registro._edit.superviso" /></div>
                        <div style="grid-column:1 / -1;"><label>Observaciones</label><textarea [(ngModel)]="registro._edit.observaciones"></textarea></div>
                      </div>
                      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                        <button type="button" class="tab-btn" (click)="saveHistorialEdits(editingEquipoCodigo, registro)">Guardar</button>
                        <button type="button" class="tab-btn" (click)="cancelHistorialEdits(registro)">Cancelar</button>
                      </div>
                    </div>
                    <ng-template #viewHistorial>
                      <div class="historial-grid">
                        <div class="historial-item"><span class="historial-label">Tipo Historial:</span><span>{{ registro.tipo_historial || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Código Registro:</span><span>{{ registro.codigo_registro || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Realizó:</span><span>{{ registro.realizo || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Supervisó:</span><span>{{ registro.superviso || 'N/A' }}</span></div>
                        <div class="historial-item historial-item-full" *ngIf="registro.observaciones"><span class="historial-label">Observaciones:</span><span>{{ registro.observaciones }}</span></div>
                      </div>
                      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                        <button type="button" class="tab-btn" (click)="startEditHistorial(registro)">Editar</button>
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #noModalHistorial>
              <div class="no-historial-message">
                <i class="fas fa-history"></i>
                <p>No hay registros de historial para este equipo</p>
              </div>
            </ng-template>

          </div>

          <div *ngIf="editModalActiveTab === 'intervalo'">
            <!-- List existing intervalo registros for the editing equipo -->
            <div *ngIf="editingEquipoCodigo && intervaloPorEquipo[editingEquipoCodigo] && intervaloPorEquipo[editingEquipoCodigo].length > 0; else noModalIntervalo">
              <div class="historial-records-container">
                <div *ngFor="let registro of intervaloPorEquipo[editingEquipoCodigo]" class="historial-record-card">
                  <div class="historial-header" (click)="toggleIntervaloRegistro(editingEquipoCodigo, registro.consecutivo)">
                    <span class="historial-consecutivo">
                      <i class="fas" [ngClass]="intervaloExpandido[editingEquipoCodigo + '_' + registro.consecutivo] ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                      Registro #{{ registro.consecutivo }}
                    </span>
                    <span class="historial-fecha">{{ registro.fecha_c2 ? (registro.fecha_c2 | date: 'yyyy/MM/dd') : (registro.fecha_c1 ? (registro.fecha_c1 | date: 'yyyy/MM/dd') : 'N/A') }}</span>
                  </div>
                  <div class="historial-body" *ngIf="intervaloExpandido[editingEquipoCodigo + '_' + registro.consecutivo]">
                    <div *ngIf="registro._edit; else viewIntervalo">
                      <div class="form-grid">
                        <div><label>Unidad nominal (g)</label><input type="number" step="0.0001" [(ngModel)]="registro._edit.unidad_nominal_g" /></div>
                        <div><label>Calibración 1</label><input [(ngModel)]="registro._edit.calibracion_1" /></div>
                        <div><label>Fecha Cal. 1</label><input type="date" [(ngModel)]="registro._edit.fecha_c1" /></div>
                        <div><label>Error Cal. 1 (g)</label><input type="number" step="0.0001" [(ngModel)]="registro._edit.error_c1_g" /></div>
                        <div><label>Calibración 2</label><input [(ngModel)]="registro._edit.calibracion_2" /></div>
                        <div><label>Fecha Cal. 2</label><input type="date" [(ngModel)]="registro._edit.fecha_c2" /></div>
                        <div><label>Error Cal. 2 (g)</label><input type="number" step="0.0001" [(ngModel)]="registro._edit.error_c2_g" /></div>
                        <div><label>Diferencia días</label><input type="number" [(ngModel)]="registro._edit.diferencia_dias" /></div>
                        <div><label>Desviación</label><input type="number" step="0.0001" [(ngModel)]="registro._edit.desviacion" /></div>
                        <div><label>Deriva</label><input type="number" step="0.0001" [(ngModel)]="registro._edit.deriva" /></div>
                        <div><label>Tolerancia (g)</label><input type="number" step="0.0001" [(ngModel)]="registro._edit.tolerancia_g" /></div>
                        <div><label>Intervalo Cal. (días)</label><input type="number" [(ngModel)]="registro._edit.intervalo_calibraciones_dias" /></div>
                        <div style="grid-column:1 / -1;"><label>Intervalo Cal. (años)</label><input type="number" step="0.0001" [(ngModel)]="registro._edit.intervalo_calibraciones_anios" /></div>
                      </div>
                      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                        <button type="button" class="tab-btn" (click)="saveIntervaloEdits(editingEquipoCodigo, registro)">Guardar</button>
                        <button type="button" class="tab-btn" (click)="cancelIntervaloEdits(registro)">Cancelar</button>
                      </div>
                    </div>
                    <ng-template #viewIntervalo>
                      <div class="historial-grid">
                        <div class="historial-item"><span class="historial-label">Unidad Nominal (g):</span><span>{{ registro.unidad_nominal_g || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Calibración 1:</span><span>{{ registro.calibracion_1 || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Fecha Cal. 1:</span><span>{{ registro.fecha_c1 ? (registro.fecha_c1 | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Error Cal. 1 (g):</span><span>{{ registro.error_c1_g || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Calibración 2:</span><span>{{ registro.calibracion_2 || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Fecha Cal. 2:</span><span>{{ registro.fecha_c2 ? (registro.fecha_c2 | date: 'yyyy/MM/dd') : 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Error Cal. 2 (g):</span><span>{{ registro.error_c2_g || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Diferencia Días:</span><span>{{ registro.diferencia_dias || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Desviación:</span><span>{{ registro.desviacion || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Deriva:</span><span>{{ registro.deriva || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Tolerancia (g):</span><span>{{ registro.tolerancia_g || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Intervalo Cal. (días):</span><span>{{ registro.intervalo_calibraciones_dias || 'N/A' }}</span></div>
                        <div class="historial-item"><span class="historial-label">Intervalo Cal. (años):</span><span>{{ registro.intervalo_calibraciones_anios || 'N/A' }}</span></div>
                      </div>
                      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                        <button type="button" class="tab-btn" (click)="startEditIntervalo(registro)">Editar</button>
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #noModalIntervalo>
              <div class="no-historial-message">
                <i class="fas fa-calendar-alt"></i>
                <p>No hay registros de intervalo para este equipo</p>
              </div>
            </ng-template>

            <!-- Small quick-add inputs (kept for convenience) -->
            <div style="margin-top:12px" class="form-grid">
              <div>
                <label>Descripción</label>
                <input [(ngModel)]="newIntervaloDescripcion" />
              </div>
              <div>
                <label>Fecha</label>
                <input type="date" [(ngModel)]="newIntervaloFecha" />
              </div>
            </div>
          </div>
        </div>

        </div>

      </div>
    </div>

  </div>
    